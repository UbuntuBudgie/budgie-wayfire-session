#!/bin/bash
# Wayfire Magnifier Helper Script
# Toggles or controls the Wayfire magnifier (mag or zoom plugin)

CONFIG_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/budgie-desktop/wayfire/wayfire.ini"
STATE_FILE="${XDG_RUNTIME_DIR:-/tmp}/wayfire-mag-state"

# Check if mag plugin is enabled in config
check_mag_plugin() {
    if [ -f "$CONFIG_FILE" ]; then
        grep -q "^plugins.*mag" "$CONFIG_FILE" || grep -q "^plugins.*zoom" "$CONFIG_FILE"
        return $?
    fi
    return 1
}

# Toggle magnifier using Wayfire IPC
toggle_magnifier() {
    # Check if magnifier is currently active
    if [ -f "$STATE_FILE" ]; then
        # Magnifier is on, turn it off
        wf-msg mag toggle 2>/dev/null || wf-msg zoom toggle 2>/dev/null
        rm -f "$STATE_FILE"
        echo "Magnifier: OFF"
    else
        # Magnifier is off, turn it on
        wf-msg mag toggle 2>/dev/null || wf-msg zoom toggle 2>/dev/null
        touch "$STATE_FILE"
        echo "Magnifier: ON"
    fi
}

# Zoom in
zoom_in() {
    wf-msg mag zoom-in 2>/dev/null || wf-msg zoom in 2>/dev/null
    echo "Magnifier: Zoom In"
}

# Zoom out
zoom_out() {
    wf-msg mag zoom-out 2>/dev/null || wf-msg zoom out 2>/dev/null
    echo "Magnifier: Zoom Out"
}

# Main logic
case "${1:-toggle}" in
    toggle)
        if ! check_mag_plugin; then
            echo "Warning: mag or zoom plugin not found in ~/.config/budgie-desktop/wayfire/wayfire.ini" >&2
            echo "Please enable the plugin in [core] plugins list" >&2
            exit 1
        fi
        toggle_magnifier
        ;;
    on)
        if ! check_mag_plugin; then
            echo "Error: mag or zoom plugin not enabled" >&2
            exit 1
        fi
        if [ ! -f "$STATE_FILE" ]; then
            toggle_magnifier
        fi
        ;;
    off)
        if [ -f "$STATE_FILE" ]; then
            toggle_magnifier
        fi
        ;;
    zoom-in|in)
        zoom_in
        ;;
    zoom-out|out)
        zoom_out
        ;;
    *)
        echo "Usage: $0 {toggle|on|off|zoom-in|zoom-out}"
        echo ""
        echo "Commands:"
        echo "  toggle     - Toggle magnifier on/off (default)"
        echo "  on         - Turn magnifier on"
        echo "  off        - Turn magnifier off"
        echo "  zoom-in    - Increase magnification"
        echo "  zoom-out   - Decrease magnification"
        exit 1
        ;;
esac